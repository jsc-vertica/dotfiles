#!/bin/bash
# ~/.bashrc - Main bash configuration

# If not running interactively, don't do anything
[[ $- != *i* ]] && return

# Source global definitions
if [ -f /etc/bashrc ]; then
    . /etc/bashrc
fi

# =============================================================================
# HISTORY SETTINGS
# =============================================================================
HISTSIZE=10000                    # Commands in memory
HISTFILESIZE=20000               # Commands in history file
HISTCONTROL=ignoreboth:erasedups # Ignore duplicates and lines starting with space
HISTIGNORE="ls:ll:la:cd:pwd:exit:date:history:clear:bg:fg:jobs"
HISTTIMEFORMAT="%Y-%m-%d %H:%M:%S "
shopt -s histappend              # Append to history file, don't overwrite
shopt -s cmdhist                 # Save multi-line commands as one command

# =============================================================================
# SHELL OPTIONS
# =============================================================================
shopt -s checkwinsize            # Check window size after each command
shopt -s expand_aliases          # Expand aliases
shopt -s cdspell                 # Correct minor spelling errors in cd
shopt -s dirspell                # Correct minor spelling errors in directory names
shopt -s nocaseglob             # Case-insensitive globbing
shopt -s autocd                 # Change to named directory
shopt -s globstar               # ** recursive glob

# Set vi mode (comment out if you prefer emacs mode)
set -o vi

# =============================================================================
# ENVIRONMENT VARIABLES
# =============================================================================
export EDITOR="rider --wait"             # Change to vim, emacs, etc. as preferred
export VISUAL="$EDITOR"
export PAGER="less"
export BROWSER="firefox"         # Change as needed
export TERM="xterm-256color"

# Language and locale
export LANG="en_US.UTF-8"
export LC_ALL="en_US.UTF-8"

# Less options
export LESS="-R -M -i -j5"      # Raw colors, verbose, ignore case, jump 5 lines
export LESSHISTFILE="/dev/null" # Don't save less history

# Colored man pages
export LESS_TERMCAP_mb=$'\e[1;32m'     # Begin blinking
export LESS_TERMCAP_md=$'\e[1;32m'     # Begin bold
export LESS_TERMCAP_me=$'\e[0m'        # End mode
export LESS_TERMCAP_se=$'\e[0m'        # End standout-mode
export LESS_TERMCAP_so=$'\e[01;33m'    # Begin standout-mode
export LESS_TERMCAP_ue=$'\e[0m'        # End underline
export LESS_TERMCAP_us=$'\e[1;4;31m'   # Begin underline

# =============================================================================
# PATH CONFIGURATION
# =============================================================================
# Add common directories to PATH if they exist
for dir in "$HOME/bin" "$HOME/.local/bin" "$HOME/.cargo/bin" "$HOME/go/bin"; do
    if [[ -d "$dir" && ":$PATH:" != *":$dir:"* ]]; then
        PATH="$dir:$PATH"
    fi
done

# =============================================================================
# PROMPT CONFIGURATION
# =============================================================================
# Color definitions
RED='\[\033[0;31m\]'
GREEN='\[\033[0;32m\]'
YELLOW='\[\033[0;33m\]'
BLUE='\[\033[0;34m\]'
PURPLE='\[\033[0;35m\]'
CYAN='\[\033[0;36m\]'
WHITE='\[\033[0;37m\]'
BOLD='\[\033[1m\]'
RESET='\[\033[0m\]'

# Color definitions for echo (without \[ \] brackets)
ECHO_RED='\033[0;31m'
ECHO_GREEN='\033[0;32m'
ECHO_YELLOW='\033[0;33m'
ECHO_BLUE='\033[0;34m'
ECHO_PURPLE='\033[0;35m'
ECHO_CYAN='\033[0;36m'
ECHO_WHITE='\033[0;37m'
ECHO_BOLD='\033[1m'
ECHO_RESET='\033[0m'

# Git prompt function
git_prompt() {
    local git_status git_branch
    git_branch=$(git symbolic-ref --short HEAD 2>/dev/null)
    if [[ -n "$git_branch" ]]; then
        git_status=$(git status --porcelain 2>/dev/null)
        if [[ -n "$git_status" ]]; then
            echo " (${git_branch}*)"
        else
            echo " (${git_branch})"
        fi
    fi
}

# Set prompt
if [[ $EUID -eq 0 ]]; then
    # Root prompt (red)
    PS1="${RED}${BOLD}${BLUE}\w${YELLOW}\$(git_prompt)${RESET}${RED}# ${RESET}"
else
    # Regular user prompt (green)
    PS1="${GREEN}${BOLD}${BLUE}\w${YELLOW}\$(git_prompt)${RESET}${GREEN}\$ ${RESET}"
fi

# =============================================================================
# ALIASES
# =============================================================================
# Basic commands
alias ls='lsd -lha --date "+%d-%m-%Y %H:%M:%S" --blocks date,size,name --group-dirs first'
alias grep='grep --color=auto'
alias fgrep='fgrep --color=auto'
alias egrep='egrep --color=auto'

# Safety nets
alias rm='rm -i'
alias cp='cp -i'
alias mv='mv -i'
alias ln='ln -i'

# Navigation
alias ..='cd ..'
alias ...='cd ../..'
alias ....='cd ../../..'
alias .....='cd ../../../..'

# Shortcuts
alias h='history'
alias j='jobs -l'
alias c='clear'
alias x='exit'
alias q='exit'

# System information
alias df='df -h'
alias du='du -h'
alias free='free -h'
alias ps='ps auxf'
alias psg='ps aux | grep -v grep | grep -i -e VSZ -e'
alias top='htop'

# Network
alias ping='ping -c 5'
alias ports='netstat -tulanp'
alias myip='curl -s ifconfig.me'

# Date and time
alias now='date +"%T"'
alias nowdate='date +"%d-%m-%Y"'

# Archives
alias mktar='tar -cvf'
alias mkbz2='tar -cvjf'
alias mkgz='tar -cvzf'
alias untar='tar -xvf'
alias unbz2='tar -xvjf'
alias ungz='tar -xvzf'

# =============================================================================
# FUNCTIONS
# =============================================================================
# Create directory and cd into it
mkcd() {
    mkdir -p "$1" && cd "$1"
}

# Extract various archive formats
extract() {
    if [ -f "$1" ]; then
        case $1 in
            *.tar.bz2)   tar xjf "$1"     ;;
            *.tar.gz)    tar xzf "$1"     ;;
            *.bz2)       bunzip2 "$1"     ;;
            *.rar)       unrar x "$1"     ;;
            *.gz)        gunzip "$1"      ;;
            *.tar)       tar xf "$1"      ;;
            *.tbz2)      tar xjf "$1"     ;;
            *.tgz)       tar xzf "$1"     ;;
            *.zip)       unzip "$1"       ;;
            *.Z)         uncompress "$1"  ;;
            *.7z)        7z x "$1"        ;;
            *)           echo "'$1' cannot be extracted via extract()" ;;
        esac
    else
        echo "'$1' is not a valid file"
    fi
}

# Find file by name
ff() {
    find . -type f -name "*$1*" 2>/dev/null
}

# Find directory by name
fd() {
    find . -type d -name "*$1*" 2>/dev/null
}

# Show PATH in readable format
path() {
    echo "$PATH" | tr ':' '\n' | nl
}

# Weather function (requires curl)
weather() {
    local location="${1:-}"
    curl -s "wttr.in/${location}?format=3"
}

# =============================================================================
# COMPLETION
# =============================================================================
# Enable programmable completion features
if ! shopt -oq posix; then
    if [ -f /usr/share/bash-completion/bash_completion ]; then
        . /usr/share/bash-completion/bash_completion
    elif [ -f /etc/bash_completion ]; then
        . /etc/bash_completion
    fi
fi

# =============================================================================
# ADDITIONAL CONFIGURATIONS
# =============================================================================
# Load local bashrc if it exists
if [ -f ~/.bashrc.local ]; then
    . ~/.bashrc.local
fi

# Load work-specific configuration if it exists
if [ -f ~/.bashrc.work ]; then
    . ~/.bashrc.work
fi

# Welcome message
if [[ -t 1 ]]; then
    echo -e "${ECHO_BLUE}Today is $(date '+%A, %B %d, %Y')${ECHO_RESET}"
    
    # Show system info (trim leading whitespace)
    if command -v uptime &> /dev/null; then
        echo -e "${ECHO_YELLOW}$(uptime | sed 's/^ *//')${ECHO_RESET}"
    fi
fi

# =============================================================================
# PATH
# =============================================================================
export PATH="/home/jsc/.local/bin:$PATH"
export PATH="$PATH:$HOME/.dotnet/tools"
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # This loads nvm
[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"  # This loads nvm bash_completion
export FUNCTIONS_CORE_TOOLS_TELEMETRY_OPTOUT=1
